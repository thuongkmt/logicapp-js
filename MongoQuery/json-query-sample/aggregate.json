{  "aggregate": [    {      "$match": {        "event.eventPromChannelStores.orderSubmitPromID": @{triggerBody()['promotionId']},        "event.eventPromChannelStores.storeList.storeID": @{triggerBody()['storeNumber']},        "event.eventPromChannelStores.storeList.visible": "Y",        "targetBackend": @{variables('targetBackend')}      }    },    {      "$project": {        "event.eventCode": 1,        "event.eventPromChannelStores.orderSubmitPromID": 1,        "event.eventPromChannelStores.promCode": 1,        "event.eventPromChannelStores.promPrefSeq": 1,        "event.eventPromChannelStores.storeList": 1,        "event.itemList.itemID": 1,        "event.itemList.itemPromChannels": 1,        "event.saleType": 1,        "orderCloseDate": 1,        "orderOpenDate": 1,        "targetBackend": 1      }    },    {      "$unwind": "$event"    },    {      "$unwind": "$event.eventPromChannelStores"    },    {      "$unwind": "$event.eventPromChannelStores.storeList"    },    {      "$match": {        "event.eventPromChannelStores.storeList.storeID": @{triggerBody()['storeNumber']},        "event.eventPromChannelStores.storeList.visible": "Y"      }    },    {      "$unwind": "$event.itemList"    },    {      "$match": {        "event.itemList.itemID": {          "$in": @{outputs('ExeJavaScriptCode_getUnique_itemCode')}        }      }    },    {      "$project": {        "event.itemList.itemPromChannels.allocationRule": 0,        "event.itemList.itemPromChannels.catGroup": 0,        "event.itemList.itemPromChannels.catPage": 0,        "event.itemList.itemPromChannels.catSubGroup": 0,        "event.itemList.itemPromChannels.comments": 0,        "event.itemList.itemPromChannels.promProdNo": 0      }    },    {      "$group": {        "_id": {          "event": {            "eventCode": "$event.eventCode",            "eventPromChannelStores": "$event.eventPromChannelStores",            "saleType": "$event.saleType"          },          "orderCloseDate": "$orderCloseDate",          "orderOpenDate": "$orderOpenDate",          "productId": "$_id",          "targetBackend": "$targetBackend"        },        "itemLists": {          "$push": {            "itemID": "$event.itemList.itemID",            "itemPromChannels": "$event.itemList.itemPromChannels"          }        }      }    },    {      "$group": {        "_id": {          "orderCloseDate": "$$ROOT._id.orderCloseDate",          "orderOpenDate": "$$ROOT._id.orderOpenDate",          "targetBackend": "$$ROOT._id.targetBackend"        },        "events": {          "$push": {            "event": "$$ROOT._id.event",            "itemLists": "$$ROOT.itemLists"          }        }      }    }  ],  "collection": "orderevents16",  "database": "@{parameters('ESL_DB_NAME')}"}