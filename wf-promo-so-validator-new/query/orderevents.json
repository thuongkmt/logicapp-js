{
    "aggregate": [
        {
            "$match": {
                "targetBackend":"AX",
                "event.eventPromChannelStores.orderSubmitPromID":"PL910",
                "event.eventPromChannelStores.storeList.storeID":"104836",
                "event.eventPromChannelStores.storeList.visible":"Y"
            }
        },
        {
            "$project": {
                "event.eventCode": 1,
                "event.eventPromChannelStores.orderSubmitPromID": 1,
                "event.eventPromChannelStores.promCode": 1,
                "event.eventPromChannelStores.promPrefSeq": 1,
                "event.eventPromChannelStores.storeList": 1,
                "event.itemList.itemID": 1,
                "event.itemList.itemPromChannels": 1,
                "event.saleType": 1,
                "orderCloseDate": 1,
                "orderOpenDate": 1,
                "targetBackend": 1
            }
        },
        {
            "$unwind": "$event"
        },
        {
            "$unwind": "$event.eventPromChannelStores"
        },
        {
            "$unwind": "$event.eventPromChannelStores.storeList"
        },
        {
            "$match": {
                "event.eventPromChannelStores.storeList.storeID": "104836",
                "event.eventPromChannelStores.storeList.visible": "Y"
            }
        },
        {
            "$unwind": "$event.itemList"
        },
        {
            "$match": {
                "event.itemList.itemID": {
                    "$in":["1033422","1033455","1222520","1374388","2079762","2093839","2101582","2119626","2166353","2194041","2249738","2249746","2249753","2301372","2312296","2328342","2331916","2340347","2371953","2400778","2404002","2412518","2412526","2421121","2421881","2465458","2474609","2482818","2482842","2490035","2500072","2504397","2504405","2504413","2506673","2506988","2507150","2534717","2534774","2534931","2538346","2538353","2548287","2550382","2550507","2565497","2565505","2565513","2588812","2596906","2596955","2608131","2619401","2620557","2620565","2620805","2620813","2620821","2620839","2620847","2620854","2620862","2620870","2621324","2622439","2622447","2679850","3034956","3366168","3372489","3405263","3437639","3655669","3656238","3656246","3656261","3666260","3666278","3666294","3666302","3690005","3690013","3690021","3690039","3690047","3690054","3794351","3799210","3816519","3816527","3863172","3863180","3863198","3863206","3863214","3863222","3863230","3863248","3876380","4172920","4202016","4202024","4202032","4360244","4360251","4903027","4905584","5056718","5131784","5158506","5158522","5160312","5263256","5271572","5277330","5328927","5329149","5330477","5330857","5330931","5331517","5331525","5331541","5331558","5331582","5331590","5331608","5331624","5331632","5331640","5331657","5331665","5331699","5331798","5331822","5331996","5332010","5332226","5332283","5345350","5350541","5350574","5350608","5350624","5350632","5350640","5350665","5350673","5350681","5350699","5350707","5350723","5350822","5350913","5355300","5360045","5363544","5364112","5364120","5391222","5443296","5443403","5496625","5496633","5496641","5496666","5496674","5496716","5496724","5496757","5496765","5496773","5496849","5496856","5496930","5498274","5507744","5522172","5545785","5545793","5545801","5546049","5546197","5549555","5550736","5550744","5550751","5550769","5556253","5556311","5556329","5556345","5556352","5556600","5557459","5564653","5585112","5597711","5602677","5602685","5604947","5604954","5604962","5604970","5604988","5604996","5605001","5605019","5605027","5605068","5605076","5605084","5610092","5628334","5628342","5628359","5628367","5636972","5636998","5638689","5638879","5641485","5671078","5674064","5674080","5674114","5674122","5674130","5674163","5674189","5674197","5674213","5674221","5674262","5674288","5674387","5674676","5674684","5674700","5674734","5674940","5675285","5675293","5675301","5675343","5675889","5688536","5696943","5709530","5709555","5709563","5709571","5709589","6028492","6044051","6044069","6044077","6050397","6053219","6053227","6053235","6053839","6056378","6091078","6094973","6101471","6101489","6101513","6155303","6167092","6172092","6174668","6188429","6188437","6188445","6189997","6195978","6196000","6210264","6210587","6210595","6210603","6212369","6212377","6212385","6212393","6212401","6212419","6212427","6212435","6213037","6233316","6233324","6240949","6276133","6280747","6280754","6287023","6287049","6287072","6287080","6287130","6287148","6287189","6287197","6287205","6287213","6287221","6287239","6287262","6319057","6319073","6319305","6320410","6320873","6320881","6324339","6325765","6327019","6327035","6327480","6327498","6329296","6329312","6329379","6329973","6329981","6329999","6330005","6330344","6348080","6369060","6370357","6370415","6370423","6378301","6378699","6396840","6400436","6406664","6408306","6408488","6410039","6410047","6410054","6410062","6410070","6410088","6410096","6410104","6410112","6410120","6410138","6410146","6410153","6410161","6430268","6433080","6435606","6442115","6442131","6442156","6442172","6512883","6514822","6523401","6528616","6532675","6536239","6536585","6536593","6539514","6551303","6555395","6555403","6555635","6555643","6557276","6557284","6557292","6567507","6573174","6594261","6607816","6610497","6633408","6633416","6633424","6641872","6646319","6651251","6653703","6653711","6653729","6653737","6653745","6653752","6660708","6666952","6666994","6672356","6672364","6694392","6694475","6694517","6694525","6696769","6696785","6696793","6696819","6697528","6719801","6719827","6719835","6719843","6719850","6719868","6722391","6725469","6725626","6726988","6737530","6741516","6747406","6747414","6747422","6747430","6748859","6748875","6753792","6763742","6764286","6764294","6764302","6764310","6765846","6765853","6765861","6765879","6767578","6767586","6774277","6774285","6774293","6774301","6774483","6774889","6782593","6790513","6806525","6806657","6821201","6821219","6826838","6826846","6826853","6830053","6838692","6848469","6848956","1791631","1791656","2166353","2312296","2388569","2388577","2404002","2476760","2588812","2643500","5271572","5350665","5350673","5363544","5496765","6028492","6056378","6091078","6188437","6188445","6348080","6351019","6406664","6433080","6512883","6573174","6660708","6689210","6748859","6753792","6767578","6782593","6804082","6806525","6806657","6848469","2166353","2312296","2404002","2588812","5271572","5350665","5350673","5363544","5496765","6028492","6056378","6188437","6188445","6351019","6406664","6433080","6435770","6512883","6573174","6689194","6719918","6737902","6748859","6753792","6767578","6806525","6848469"]
                }
            }
        },
        {
            "$unwind": "$event.itemList.itemPromChannels"
        },
        {
            "$unwind": "$event.itemList.itemPromChannels.itemPromRegions"
        },
        {
            "$match": {
                "event.itemList.itemPromChannels.itemPromRegions.region": "BRI"
            }
        },
        {
            "$unwind": "$event.itemList.itemPromChannels.itemPromPricing"
        },
        {
            "$match": {
                "event.itemList.itemPromChannels.itemPromPricing.promPriceLUKey": "BRI"
            }
        },
        {
            "$project" : {
                "event.itemList.itemPromChannels.promProdNo": 0,
                "event.itemList.itemPromChannels.catSubGroup": 0,
                "event.itemList.itemPromChannels.catPage": 0,
                "event.itemList.itemPromChannels.catGroup": 0,
                "event.itemList.itemPromChannels.comments": 0,
                "event.itemList.itemPromChannels.allocationRule": 0
            }
        },
        {
            "$group": {
                "_id" : {
                    "productId":"$_id",
                    "targetBackend":"$targetBackend",
                    "orderOpenDate":"$orderOpenDate",
                    "orderCloseDate":"$orderCloseDate",
                    "event": {
                        "eventCode":"$event.eventCode",
                        "saleType":"$event.saleType",
                        "eventPromChannelStores":"$event.eventPromChannelStores"
                    }
                },
                "itemLists": {
                    "$push": {
                      "itemID":"$event.itemList.itemID",
                      "itemPromChannels":"$event.itemList.itemPromChannels"
                    }
                }
            }
        },
        {
           "$group": {
            "_id": {
                "targetBackend":"$$ROOT._id.targetBackend",
                "orderOpenDate":"$$ROOT._id.orderOpenDate",
                "orderCloseDate":"$$ROOT._id.orderCloseDate"
            },
             "events": {
                "$push": {
                    "event":"$$ROOT._id.event",
                    "itemLists":"$$ROOT.itemLists"
                }
               }
           }
       }
    ],
    "collection": "orderevents",
    "database": "@{parameters('ESL_DB_NAME')}"
}